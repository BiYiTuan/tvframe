/**
 * Îª¿ÉÍøÂç¿Æ¼¼
 * ±àÐ´Õß£ºÍõÇïÊ¯ ÐíÐ¨
 *
 */
package reco.frame.tv;

import java.lang.ref.WeakReference;
import java.util.HashMap;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadFactory;

import reco.frame.tv.bitmap.core.BitmapCache;
import reco.frame.tv.bitmap.core.BitmapDisplayConfig;
import reco.frame.tv.bitmap.core.BitmapProcess;
import reco.frame.tv.bitmap.display.Displayer;
import reco.frame.tv.bitmap.display.SimpleDisplayer;
import reco.frame.tv.bitmap.download.Downloader;
import reco.frame.tv.bitmap.download.SimpleDownloader;
import reco.frame.tv.core.AsyncTask;
import reco.frame.tv.util.Utils;
import android.content.Context;
import android.content.res.Resources;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.drawable.BitmapDrawable;
import android.graphics.drawable.Drawable;
import android.text.TextUtils;
import android.util.DisplayMetrics;
import android.view.View;
import android.widget.Button;
import android.widget.ImageView;

public class TvBitmap {
	private TvBitmapConfig mConfig;
	private BitmapCache mImageCache;
	private BitmapProcess mBitmapProcess;
	private boolean mExitTasksEarly = false;
	private boolean mPauseWork = false;
	private final Object mPauseWorkLock = new Object();
	private Context mContext;
	private boolean mInit = false;
	private ExecutorService bitmapLoadAndDisplayExecutor;

	private static TvBitmap mTvBitmap;

	// //////////////////////// config method
	// start////////////////////////////////////
	private TvBitmap(Context context) {
		mContext = context;
		mConfig = new TvBitmapConfig(context);
		configDiskCachePath(Utils.getDiskCacheDir(context, "afinalCache")
				.getAbsolutePath());// ï¿½ï¿½ï¿½ç??ï¿½ç??ï¿½ç??ï¿½ç?ºï¿½å¯°ï¿½
		configDisplayer(new SimpleDisplayer());// ï¿½ï¿½ï¿½ç??ï¿½ï¿½ï¿½å?§ã??ï¿½ï¿½ï¿?
		configDownlader(new SimpleDownloader());// ï¿½ï¿½ï¿½ç??ï¿½æ??ï¿½æ?????ï¿½ï¿½
	}

	/**
	 * ´´½¨finalbitmap
	 * 
	 * @param ctx
	 * @return
	 */
	public static synchronized TvBitmap create(Context ctx) {
		if (mTvBitmap == null) {
			mTvBitmap = new TvBitmap(ctx.getApplicationContext());
		}
		return mTvBitmap;
	}

	/**
	 * ÉèÖÃÍ¼Æ¬ÕýÔÚ¼ÓÔØµÄÊ±ºòÏÔÊ¾µÄÍ¼Æ¬
	 * 
	 * @param bitmap
	 */
	public TvBitmap configLoadingImage(Bitmap bitmap) {
		mConfig.defaultDisplayConfig.setLoadingBitmap(bitmap);
		return this;
	}

	/**
	 * ÉèÖÃÍ¼Æ¬ÕýÔÚ¼ÓÔØµÄÊ±ºòÏÔÊ¾µÄÍ¼Æ¬
	 * 
	 * @param bitmap
	 */
	public TvBitmap configLoadingImage(int resId) {
		mConfig.defaultDisplayConfig.setLoadingBitmap(BitmapFactory
				.decodeResource(mContext.getResources(), resId));
		return this;
	}

	/**
	 * ÉèÖÃÍ¼Æ¬¼ÓÔØÊ§°ÜÊ±ºòÏÔÊ¾µÄÍ¼Æ¬
	 * 
	 * @param bitmap
	 */
	public TvBitmap configLoadfailImage(Bitmap bitmap) {
		mConfig.defaultDisplayConfig.setLoadfailBitmap(bitmap);
		return this;
	}

	/**
	 * ÉèÖÃÍ¼Æ¬¼ÓÔØÊ§°ÜÊ±ºòÏÔÊ¾µÄÍ¼Æ¬
	 * 
	 * @param resId
	 */
	public TvBitmap configLoadfailImage(int resId) {
		mConfig.defaultDisplayConfig.setLoadfailBitmap(BitmapFactory
				.decodeResource(mContext.getResources(), resId));
		return this;
	}

	/**
	 * ÅäÖÃÄ¬ÈÏÍ¼Æ¬×î´óµÄ¸ß¶È
	 * 
	 * @param bitmapHeight
	 */
	public TvBitmap configBitmapMaxHeight(int bitmapHeight) {
		mConfig.defaultDisplayConfig.setBitmapHeight(bitmapHeight);
		return this;
	}

	/**
	 * ÅäÖÃÄ¬ÈÏÍ¼Æ¬×î´óµÄ¿í¶È
	 * 
	 * @param bitmapHeight
	 */
	public TvBitmap configBitmapMaxWidth(int bitmapWidth) {
		mConfig.defaultDisplayConfig.setBitmapWidth(bitmapWidth);
		return this;
	}

	/**
	 * ÉèÖÃÏÂÔØÆ÷£¬±ÈÈçÍ¨¹ýftp»òÕßÆäËûÐ­ÒéÈ¥ÍøÂç¶ÁÈ¡Í¼Æ¬µÄÊ±ºò¿ÉÒÔÉèÖÃÕâÏî
	 * 
	 * @param downlader
	 * @return
	 */
	public TvBitmap configDownlader(Downloader downlader) {
		mConfig.downloader = downlader;
		return this;
	}

	/**
	 * ÉèÖÃÏÔÊ¾Æ÷£¬±ÈÈçÔÚÏÔÊ¾µÄ¹ý³ÌÖÐÏÔÊ¾¶¯»­µÈ
	 * 
	 * @param displayer
	 * @return
	 */
	public TvBitmap configDisplayer(Displayer displayer) {
		mConfig.displayer = displayer;
		return this;
	}

	/**
	 * ÅäÖÃ´ÅÅÌ»º´æÂ·¾¶
	 * 
	 * @param strPath
	 * @return
	 */
	public TvBitmap configDiskCachePath(String strPath) {
		if (!TextUtils.isEmpty(strPath)) {
			mConfig.cachePath = strPath;
		}
		return this;
	}

	/**
	 * ÅäÖÃÄÚ´æ»º´æ´óÐ¡ ´óÓÚ2MBÒÔÉÏÓÐÐ§
	 * 
	 * @param size
	 *            »º´æ´óÐ¡
	 */
	public TvBitmap configMemoryCacheSize(int size) {
		mConfig.memCacheSize = size;
		return this;
	}

	/**
	 * ÉèÖÃ´ÅÅÌ»º´æ°Ù·Ö±È 5MB ÒÔÉÏÓÐÐ§
	 * 
	 * @param percent
	 */
	public TvBitmap configMemoryCachePercent(float percent) {
		mConfig.memCacheSizePercent = percent;
		return this;
	}

	/**
	 * ÉèÖÃ´ÅÅÌ»º´æ´óÐ¡ 5MB ÒÔÉÏÓÐÐ§
	 * 
	 * @param size
	 */
	public TvBitmap configDiskCacheSize(int size) {
		mConfig.diskCacheSize = size;
		return this;
	}

	/**
	 * ÉèÖÃ¼ÓÔØÍ¼Æ¬µÄÏß³Ì²¢·¢ÊýÁ¿
	 * 
	 * @param size
	 */
	public TvBitmap configBitmapLoadThreadSize(int size) {
		if (size >= 1)
			mConfig.poolSize = size;
		return this;
	}

	/**
	 * ÅäÖÃÊÇ·ñÁ¢¼´»ØÊÕÍ¼Æ¬×ÊÔ´
	 * 
	 * @param recycleImmediately
	 * @return
	 */
	public TvBitmap configRecycleImmediately(boolean recycleImmediately) {
		mConfig.recycleImmediately = recycleImmediately;
		return this;
	}

	/**
	 * ³õÊ¼»¯finalBitmap
	 * 
	 * @return
	 */
	private TvBitmap init() {

		if (!mInit) {

			BitmapCache.ImageCacheParams imageCacheParams = new BitmapCache.ImageCacheParams(
					mConfig.cachePath);
			if (mConfig.memCacheSizePercent > 0.05
					&& mConfig.memCacheSizePercent < 0.8) {
				imageCacheParams.setMemCacheSizePercent(mContext,
						mConfig.memCacheSizePercent);
			} else {
				if (mConfig.memCacheSize > 1024 * 1024 * 2) {
					imageCacheParams.setMemCacheSize(mConfig.memCacheSize);
				} else {
					// ?????§ç??æ¦?ï¿½ç?????ï¿½ï¿½ï¿½ï¿½ï¿½ç??ï¿½ç??ï¿½ç??ï¿½æ¾¶??ï¿½ï¿½
					imageCacheParams.setMemCacheSizePercent(mContext, 0.3f);
				}
			}

			if (mConfig.diskCacheSize > 1024 * 1024 * 5)
				imageCacheParams.setDiskCacheSize(mConfig.diskCacheSize);

			imageCacheParams.setRecycleImmediately(mConfig.recycleImmediately);
			// init Cache
			mImageCache = new BitmapCache(imageCacheParams);

			// init Executors
			bitmapLoadAndDisplayExecutor = Executors.newFixedThreadPool(
					mConfig.poolSize, new ThreadFactory() {
						@Override
						public Thread newThread(Runnable r) {
							Thread t = new Thread(r);
							// ?????§ç??ç»¾è·¨ï¿½ï¿½ï¿½ï¿½ï¿½æµ¼ï¿½ï¿½ï¿½ï¿½ç»¾Ñ?ï¿½ï¿½???ï¿½ç????????ç»?ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½æ¤¤???ï¿½ï¿½ï¿½ï¿½??ï¿½ï¿½???ï¿½ç»¾??ï¿½ï¿½???ï¿½æ??ï¿½é??ï¿½ï¿½ï¿½ã??ï¿½ï¿½cpuï¿½ï¿½??ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½å??ï¿½ç??ï¿½ï¿½æ¾¶ï¿½???ï¿?
							t.setPriority(Thread.NORM_PRIORITY - 1);
							return t;
						}
					});

			// init BitmapProcess
			mBitmapProcess = new BitmapProcess(mConfig.downloader, mImageCache);

			mInit = true;
		}

		return this;
	}

	// //////////////////////// config method
	// end////////////////////////////////////

	public void display(View imageView, String uri) {
		doDisplay(imageView, uri, null);
	}

	public void display(View imageView, String uri, int imageWidth,
			int imageHeight) {
		BitmapDisplayConfig displayConfig = configMap.get(imageWidth + "_"
				+ imageHeight);
		if (displayConfig == null) {
			displayConfig = getDisplayConfig();
			displayConfig.setBitmapHeight(imageHeight);
			displayConfig.setBitmapWidth(imageWidth);
			configMap.put(imageWidth + "_" + imageHeight, displayConfig);
		}

		doDisplay(imageView, uri, displayConfig);
	}

	public void display(View imageView, String uri, int resId) {
		Bitmap loadingBitmap = BitmapFactory.decodeResource(
				mContext.getResources(), resId);
		if (loadingBitmap == null) {
			display(imageView, uri);
		} else {
			display(imageView, uri, loadingBitmap);
		}

	}

	public void display(View imageView, String uri, Bitmap loadingBitmap) {
		BitmapDisplayConfig displayConfig = configMap.get(String
				.valueOf(loadingBitmap));
		if (displayConfig == null) {
			displayConfig = getDisplayConfig();
			displayConfig.setLoadingBitmap(loadingBitmap);
			configMap.put(String.valueOf(loadingBitmap), displayConfig);
		}

		doDisplay(imageView, uri, displayConfig);
	}

	public void display(View imageView, String uri, Bitmap loadingBitmap,
			Bitmap laodfailBitmap) {
		BitmapDisplayConfig displayConfig = configMap.get(String
				.valueOf(loadingBitmap) + "_" + String.valueOf(laodfailBitmap));
		if (displayConfig == null) {
			displayConfig = getDisplayConfig();
			displayConfig.setLoadingBitmap(loadingBitmap);
			displayConfig.setLoadfailBitmap(laodfailBitmap);
			configMap.put(
					String.valueOf(loadingBitmap) + "_"
							+ String.valueOf(laodfailBitmap), displayConfig);
		}

		doDisplay(imageView, uri, displayConfig);
	}

	public void display(View imageView, String uri, int imageWidth,
			int imageHeight, Bitmap loadingBitmap, Bitmap laodfailBitmap) {
		BitmapDisplayConfig displayConfig = configMap.get(imageWidth + "_"
				+ imageHeight + "_" + String.valueOf(loadingBitmap) + "_"
				+ String.valueOf(laodfailBitmap));
		if (displayConfig == null) {
			displayConfig = getDisplayConfig();
			displayConfig.setBitmapHeight(imageHeight);
			displayConfig.setBitmapWidth(imageWidth);
			displayConfig.setLoadingBitmap(loadingBitmap);
			displayConfig.setLoadfailBitmap(laodfailBitmap);
			configMap.put(
					imageWidth + "_" + imageHeight + "_"
							+ String.valueOf(loadingBitmap) + "_"
							+ String.valueOf(laodfailBitmap), displayConfig);
		}

		doDisplay(imageView, uri, displayConfig);
	}

	public void display(View imageView, String uri, BitmapDisplayConfig config) {
		doDisplay(imageView, uri, config);
	}

	private void doDisplay(View imageView, String uri,
			BitmapDisplayConfig displayConfig) {
		if (!mInit) {
			init();
		}

		if (TextUtils.isEmpty(uri) || imageView == null) {
			return;
		}

		if (displayConfig == null)
			displayConfig = mConfig.defaultDisplayConfig;

		Bitmap bitmap = null;

		if (mImageCache != null) {
			bitmap = mImageCache.getBitmapFromMemoryCache(uri);
		}

		if (bitmap != null) {
			if (imageView instanceof ImageView) {
				((ImageView) imageView).setImageBitmap(bitmap);
			} else {
				imageView.setBackgroundDrawable(new BitmapDrawable(bitmap));
			}

		} else if (checkImageTask(uri, imageView)) {
			final BitmapLoadAndDisplayTask task = new BitmapLoadAndDisplayTask(
					imageView, displayConfig);
			// ?????§ç??æ¦?ï¿½ç?????ï¿½å?§ï¿½ï¿?
			final AsyncDrawable asyncDrawable = new AsyncDrawable(
					mContext.getResources(), displayConfig.getLoadingBitmap(),
					task);

			if (imageView instanceof ImageView) {
				((ImageView) imageView).setImageDrawable(asyncDrawable);
			} else {
				imageView.setBackgroundDrawable(asyncDrawable);
			}

			task.executeOnExecutor(bitmapLoadAndDisplayExecutor, uri);
		}
	}

	public void display(Button button, String uri) {
		doDisplay(button, uri, null);
	}

	private void doDisplay(Button button, String uri,
			BitmapDisplayConfig displayConfig) {
		if (!mInit) {
			init();
		}

		if (TextUtils.isEmpty(uri) || button == null) {
			return;
		}

		if (displayConfig == null)
			displayConfig = mConfig.defaultDisplayConfig;

		Bitmap bitmap = null;

		if (mImageCache != null) {
			bitmap = mImageCache.getBitmapFromMemoryCache(uri);
		}

		if (bitmap != null) {
			button.setBackgroundDrawable(new BitmapDrawable(bitmap));

		} else if (checkImageTask(uri, button)) {
			final BitmapLoadAndDisplayTask task = new BitmapLoadAndDisplayTask(
					button, displayConfig);
			// ?????§ç??æ¦?ï¿½ç?????ï¿½å?§ï¿½ï¿?
			final AsyncDrawable asyncDrawable = new AsyncDrawable(
					mContext.getResources(), displayConfig.getLoadingBitmap(),
					task);

			button.setBackgroundDrawable(asyncDrawable);

			task.executeOnExecutor(bitmapLoadAndDisplayExecutor, uri);
		}
	}

	private HashMap<String, BitmapDisplayConfig> configMap = new HashMap<String, BitmapDisplayConfig>();

	private BitmapDisplayConfig getDisplayConfig() {
		BitmapDisplayConfig config = new BitmapDisplayConfig();
		config.setAnimation(mConfig.defaultDisplayConfig.getAnimation());
		config.setAnimationType(mConfig.defaultDisplayConfig.getAnimationType());
		config.setBitmapHeight(mConfig.defaultDisplayConfig.getBitmapHeight());
		config.setBitmapWidth(mConfig.defaultDisplayConfig.getBitmapWidth());
		config.setLoadfailBitmap(mConfig.defaultDisplayConfig
				.getLoadfailBitmap());
		config.setLoadingBitmap(mConfig.defaultDisplayConfig.getLoadingBitmap());
		return config;
	}

	private void clearCacheInternalInBackgroud() {
		if (mImageCache != null) {
			mImageCache.clearCache();
		}
	}

	private void clearDiskCacheInBackgroud() {
		if (mImageCache != null) {
			mImageCache.clearDiskCache();
		}
	}

	private void clearCacheInBackgroud(String key) {
		if (mImageCache != null) {
			mImageCache.clearCache(key);
		}
	}

	private void clearDiskCacheInBackgroud(String key) {
		if (mImageCache != null) {
			mImageCache.clearDiskCache(key);
		}
	}

	/**
	 * Ö´ÐÐ¹ý´Ë·½·¨ºó,FinalBitmapµÄ»º´æÒÑ¾­Ê§Ð§,½¨ÒéÍ¨¹ýFinalBitmap.create()»ñÈ¡ÐÂµÄÊµÀý
	 * 
	 * @author fantouch
	 */
	private void closeCacheInternalInBackgroud() {
		if (mImageCache != null) {
			mImageCache.close();
			mImageCache = null;
			mTvBitmap = null;
		}
	}

	/**
	 * ÍøÂç¼ÓÔØbitmap
	 * 
	 * @param data
	 * @return
	 */
	private Bitmap processBitmap(String uri, BitmapDisplayConfig config) {
		if (mBitmapProcess != null) {
			return mBitmapProcess.getBitmap(uri, config);
		}
		return null;
	}

	/**
	 * ´Ó»º´æ£¨ÄÚ´æ»º´æºÍ´ÅÅÌ»º´æ£©ÖÐÖ±½Ó»ñÈ¡bitmap£¬×¢ÒâÕâÀïÓÐio²Ù×÷£¬×îºÃ²»Òª·ÅÔÚuiÏß³ÌÖ´ÐÐ
	 * 
	 * @param key
	 * @return
	 */
	public Bitmap getBitmapFromCache(String key) {
		Bitmap bitmap = getBitmapFromMemoryCache(key);
		if (bitmap == null)
			bitmap = getBitmapFromDiskCache(key);

		return bitmap;
	}

	/**
	 * ´ÓÄÚ´æ»º´æÖÐ»ñÈ¡bitmap
	 * 
	 * @param key
	 * @return
	 */
	public Bitmap getBitmapFromMemoryCache(String key) {
		return mImageCache.getBitmapFromMemoryCache(key);
	}

	/**
	 * ´Ó´ÅÅÌ»º´æÖÐ»ñÈ¡bitmap£¬£¬×¢ÒâÕâÀïÓÐio²Ù×÷£¬×îºÃ²»Òª·ÅÔÚuiÏß³ÌÖ´ÐÐ
	 * 
	 * @param key
	 * @return
	 */
	public Bitmap getBitmapFromDiskCache(String key) {
		return getBitmapFromDiskCache(key, null);
	}

	public Bitmap getBitmapFromDiskCache(String key, BitmapDisplayConfig config) {
		return mBitmapProcess.getFromDisk(key, config);
	}

	public void setExitTasksEarly(boolean exitTasksEarly) {
		mExitTasksEarly = exitTasksEarly;
	}

	/**
	 * activity onResumeµÄÊ±ºòµ÷ÓÃÕâ¸ö·½·¨£¬ÈÃ¼ÓÔØÍ¼Æ¬Ïß³Ì¼ÌÐø
	 */
	public void onResume() {
		setExitTasksEarly(false);
	}

	/**
	 * activity onPauseµÄÊ±ºòµ÷ÓÃÕâ¸ö·½·¨£¬ÈÃÏß³ÌÔÝÍ£
	 */
	public void onPause() {
		setExitTasksEarly(true);
	}

	/**
	 * activity onDestroyµÄÊ±ºòµ÷ÓÃÕâ¸ö·½·¨£¬ÊÍ·Å»º´æ
	 * Ö´ÐÐ¹ý´Ë·½·¨ºó,FinalBitmapµÄ»º´æÒÑ¾­Ê§Ð§,½¨ÒéÍ¨¹ýFinalBitmap.create()»ñÈ¡ÐÂµÄÊµÀý
	 * 
	 * @author fantouch
	 */
	public void onDestroy() {
		closeCache();
	}

	/**
	 * Çå³ýËùÓÐ»º´æ£¨´ÅÅÌºÍÄÚ´æ£©
	 */
	public void clearCache() {
		new CacheExecutecTask().execute(CacheExecutecTask.MESSAGE_CLEAR);
	}

	/**
	 * ¸ù¾ÝkeyÇå³ýÖ¸¶¨µÄÄÚ´æ»º´æ
	 * 
	 * @param key
	 */
	public void clearCache(String key) {
		new CacheExecutecTask().execute(CacheExecutecTask.MESSAGE_CLEAR_KEY,
				key);
	}

	/**
	 * Çå³ý»º´æ
	 */
	public void clearMemoryCache() {
		if (mImageCache != null)
			mImageCache.clearMemoryCache();
	}

	/**
	 * ¸ù¾ÝkeyÇå³ýÖ¸¶¨µÄÄÚ´æ»º´æ
	 * 
	 * @param key
	 */
	public void clearMemoryCache(String key) {
		if (mImageCache != null)
			mImageCache.clearMemoryCache(key);
	}

	/**
	 * å¨?ï¿½ï¿½ï¿½ã??ï¿½ï¿½ï¿½ï¿½ï¿½ç??ï¿½ç??ï¿?
	 */
	public void clearDiskCache() {
		new CacheExecutecTask().execute(CacheExecutecTask.MESSAGE_CLEAR_DISK);
	}

	/**
	 * Çå³ý´ÅÅÌ»º´æ
	 * 
	 * @param key
	 */
	public void clearDiskCache(String key) {
		new CacheExecutecTask().execute(
				CacheExecutecTask.MESSAGE_CLEAR_KEY_IN_DISK, key);
	}

	/**
	 * ¹Ø±Õ»º´æ Ö´ÐÐ¹ý´Ë·½·¨ºó,FinalBitmapµÄ»º´æÒÑ¾­Ê§Ð§,½¨ÒéÍ¨¹ýFinalBitmap.create()»ñÈ¡ÐÂµÄÊµÀý
	 * 
	 * @author fantouch
	 */
	public void closeCache() {
		new CacheExecutecTask().execute(CacheExecutecTask.MESSAGE_CLOSE);
	}

	/**
	 * ÍË³öÕýÔÚ¼ÓÔØµÄÏß³Ì£¬³ÌÐòÍË³öµÄÊ±ºòµ÷ÓÃ´Ê·½·¨
	 * 
	 * @param exitTasksEarly
	 */
	public void exitTasksEarly(boolean exitTasksEarly) {
		mExitTasksEarly = exitTasksEarly;
		if (exitTasksEarly)
			pauseWork(false);// ??????ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ç»¾è·¨ï¿½ï¿½ç¼?ï¿½ï¿½ï¿½ï¿½
	}

	/**
	 * ÔÝÍ£ÕýÔÚ¼ÓÔØµÄÏß³Ì£¬¼àÌýlistview»òÕßgridviewÕýÔÚ»¬¶¯µÄÊ±ºòÌõÓÃ´Ê·½·¨
	 * 
	 * @param pauseWork
	 *            trueÍ£Ö¹ÔÝÍ£Ïß³Ì£¬false¼ÌÐøÏß³Ì
	 */
	public void pauseWork(boolean pauseWork) {
		synchronized (mPauseWorkLock) {
			mPauseWork = pauseWork;
			if (!mPauseWork) {
				mPauseWorkLock.notifyAll();
			}
		}
	}

	private static BitmapLoadAndDisplayTask getBitmapTaskFromImageView(
			View imageView) {
		if (imageView != null) {
			Drawable drawable = null;
			if (imageView instanceof ImageView) {
				drawable = ((ImageView) imageView).getDrawable();
			} else {
				drawable = imageView.getBackground();
			}

			if (drawable instanceof AsyncDrawable) {
				final AsyncDrawable asyncDrawable = (AsyncDrawable) drawable;
				return asyncDrawable.getBitmapWorkerTask();
			}
		}
		return null;
	}

	/**
	 * ¼ì²â imageViewÖÐÊÇ·ñÒÑ¾­ÓÐÏß³ÌÔÚÔËÐÐ
	 * 
	 * @param data
	 * @param imageView
	 * @return true Ã»ÓÐ false ÓÐÏß³ÌÔÚÔËÐÐÁË
	 */
	public static boolean checkImageTask(Object data, View imageView) {
		final BitmapLoadAndDisplayTask bitmapWorkerTask = getBitmapTaskFromImageView(imageView);

		if (bitmapWorkerTask != null) {
			final Object bitmapData = bitmapWorkerTask.data;
			if (bitmapData == null || !bitmapData.equals(data)) {
				bitmapWorkerTask.cancel(true);
			} else {
				// ï¿½ï¿½ï¿½æ??ï¿½æ??ï¿½ç»¾è·?ï¿½ï¿½å®¸è??ï¿½ï¿½ï¿½ï¿½???ï¿½Ñ?ï¿½ï¿½
				return false;
			}
		}
		return true;
	}

	private static class AsyncDrawable extends BitmapDrawable {
		private final WeakReference<BitmapLoadAndDisplayTask> bitmapWorkerTaskReference;

		public AsyncDrawable(Resources res, Bitmap bitmap,
				BitmapLoadAndDisplayTask bitmapWorkerTask) {
			super(res, bitmap);
			bitmapWorkerTaskReference = new WeakReference<BitmapLoadAndDisplayTask>(
					bitmapWorkerTask);
		}

		public BitmapLoadAndDisplayTask getBitmapWorkerTask() {
			return bitmapWorkerTaskReference.get();
		}
	}

	private class CacheExecutecTask extends AsyncTask<Object, Void, Void> {
		public static final int MESSAGE_CLEAR = 1;
		public static final int MESSAGE_CLOSE = 2;
		public static final int MESSAGE_CLEAR_DISK = 3;
		public static final int MESSAGE_CLEAR_KEY = 4;
		public static final int MESSAGE_CLEAR_KEY_IN_DISK = 5;

		@Override
		protected Void doInBackground(Object... params) {
			switch ((Integer) params[0]) {
			case MESSAGE_CLEAR:
				clearCacheInternalInBackgroud();
				break;
			case MESSAGE_CLOSE:
				closeCacheInternalInBackgroud();
				break;
			case MESSAGE_CLEAR_DISK:
				clearDiskCacheInBackgroud();
				break;
			case MESSAGE_CLEAR_KEY:
				clearCacheInBackgroud(String.valueOf(params[1]));
				break;
			case MESSAGE_CLEAR_KEY_IN_DISK:
				clearDiskCacheInBackgroud(String.valueOf(params[1]));
				break;
			}
			return null;
		}
	}

	/**
	 * bitmapÏÂÔØÏÔÊ¾µÄÏß³Ì
	 * 
	 * @author michael yang
	 */
	private class BitmapLoadAndDisplayTask extends
			AsyncTask<Object, Void, Bitmap> {
		private Object data;
		private final WeakReference<View> imageViewReference;
		private final BitmapDisplayConfig displayConfig;

		public BitmapLoadAndDisplayTask(View imageView,
				BitmapDisplayConfig config) {
			imageViewReference = new WeakReference<View>(imageView);
			displayConfig = config;
		}

		@Override
		protected Bitmap doInBackground(Object... params) {
			data = params[0];
			final String dataString = String.valueOf(data);
			Bitmap bitmap = null;

			synchronized (mPauseWorkLock) {
				while (mPauseWork && !isCancelled()) {
					try {
						mPauseWorkLock.wait();
					} catch (InterruptedException e) {
					}
				}
			}

			if (bitmap == null && !isCancelled()
					&& getAttachedImageView() != null && !mExitTasksEarly) {
				bitmap = processBitmap(dataString, displayConfig);
			}

			if (bitmap != null) {
				mImageCache.addToMemoryCache(dataString, bitmap);
			}

			return bitmap;
		}

		@Override
		protected void onPostExecute(Bitmap bitmap) {
			if (isCancelled() || mExitTasksEarly) {
				bitmap = null;
			}

			// ï¿½ï¿½???ï¿½ï¿½ç»¾è·¨ï¿½ï¿½ï¿½ï¿½ï¿½è¤°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?imageviewï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½å??ï¿½ï¿½
			final View imageView = getAttachedImageView();
			if (bitmap != null && imageView != null) {
				mConfig.displayer.loadCompletedisplay(imageView, bitmap,
						displayConfig);
			} else if (bitmap == null && imageView != null) {
				mConfig.displayer.loadFailDisplay(imageView,
						displayConfig.getLoadfailBitmap());
			}
		}

		@Override
		protected void onCancelled(Bitmap bitmap) {
			super.onCancelled(bitmap);
			synchronized (mPauseWorkLock) {
				mPauseWorkLock.notifyAll();
			}
		}

		/**
		 * »ñÈ¡Ïß³ÌÆ¥ÅäµÄimageView,·ÀÖ¹³öÏÖÉÁ¶¯µÄÏÖÏó
		 * 
		 * @return
		 */
		private View getAttachedImageView() {
			final View imageView = imageViewReference.get();
			final BitmapLoadAndDisplayTask bitmapWorkerTask = getBitmapTaskFromImageView(imageView);

			if (this == bitmapWorkerTask) {
				return imageView;
			}

			return null;
		}
	}

	/**
	 * @title ÅäÖÃÐÅÏ¢
	 * @description FinalBitmapµÄÅäÖÃÐÅÏ¢
	 * @company Ì½Ë÷ÕßÍøÂç¹¤×÷ÊÒ(www.tsz.net)
	 * @author michael Young (www.YangFuhai.com)
	 * @version 1.0
	 * @created 2012-10-28
	 */
	private class TvBitmapConfig {
		public String cachePath;
		public Displayer displayer;
		public Downloader downloader;
		public BitmapDisplayConfig defaultDisplayConfig;
		public float memCacheSizePercent;// »º´æ°Ù·Ö±È£¬androidÏµÍ³·ÖÅä¸øÃ¿¸öapkÄÚ´æµÄ´óÐ¡
		public int memCacheSize;// ÄÚ´æ»º´æ°Ù·Ö±È
		public int diskCacheSize;// ´ÅÅÌ°Ù·Ö±È
		public int poolSize = 3;// Ä¬ÈÏµÄÏß³Ì³ØÏß³Ì²¢·¢ÊýÁ¿
		public boolean recycleImmediately = true;// ÊÇ·ñÁ¢¼´»ØÊÕÄÚ´æ

		public TvBitmapConfig(Context context) {
			defaultDisplayConfig = new BitmapDisplayConfig();

			defaultDisplayConfig.setAnimation(null);
			defaultDisplayConfig
					.setAnimationType(BitmapDisplayConfig.AnimationType.fadeIn);

			// ?????§ç??ï¿½ï¿½??§ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½??§ã??ï¿½ï¿½ï¿½æ¾¶???????µé?©ï¿½ï¿½æ?????ï¿½ï¿½éª?ï¿½ï¿½ï¿½ï¿½æ¾¶Ñ?ï¿½ï¿½,æ¦?ï¿½ç?????è´????ï¿½é??ï¿½ç?¹è??å®³ï¿½ï¿½ï¿½1/2???ï¿?
			DisplayMetrics displayMetrics = context.getResources()
					.getDisplayMetrics();
			int defaultWidth = (int) Math.floor(displayMetrics.widthPixels / 2);
			defaultDisplayConfig.setBitmapHeight(defaultWidth);
			defaultDisplayConfig.setBitmapWidth(defaultWidth);

		}
	}

}
